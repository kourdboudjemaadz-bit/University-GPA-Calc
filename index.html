<!DOCTYPE html>
<html lang="ar" dir="rtl" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SMAIC - GPA Calculator | Royal Edition</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&family=Poppins:wght@400;600;700;900&family=Amiri:wght@400;700&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html-to-image/1.11.11/html-to-image.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        :root {
            --primary: #4f46e5; --primary-dark: #4338ca; --accent: #fbbf24;
            --bg-body: #f0f4ff; --bg-gradient: linear-gradient(135deg, #f0f4ff 0%, #e0e7ff 100%);
            --card-bg: rgba(255, 255, 255, 0.98); --text-main: #1e293b;
            --input-bg: #f8fafc; --mention-bg: #f1f5f9;
            --danger: #ef4444; --success: #10b981;
            --font-ar: 'Cairo', sans-serif; --font-en: 'Poppins', sans-serif;
        }

        [data-theme="dark"] {
            --primary: #6366f1; --bg-body: #0f172a;
            --bg-gradient: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            --card-bg: rgba(30, 41, 59, 0.98); --text-main: #f1f5f9;
            --input-bg: #334155; --mention-bg: #1e293b;
        }

        body { font-family: var(--font-ar); background: var(--bg-gradient); margin: 0; padding: 20px; color: var(--text-main); min-height: 100vh; transition: 0.3s; }
        html[lang="en"] body { font-family: var(--font-en); }

        .container {
            width: 100%; max-width: 900px; background: var(--card-bg);
            border-radius: 24px; margin: 0 auto; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
            overflow: hidden; position: relative; border: 1px solid rgba(255,255,255,0.1);
        }

        /* Watermark */
        .watermark {
            position: absolute; top: 50%; left: 50%; width: 500px; height: 500px;
            transform: translate(-50%, -50%) rotate(-10deg); z-index: 0; pointer-events: none; opacity: 0.12;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 500 500'%3E%3Cdefs%3E%3Cpath id='textcircle' d='M250,400 a150,150 0 0,1 0,-300 a150,150 0 0,1 0,300 Z' transform='rotate(180,250,250)'/%3E%3C/defs%3E%3Cg style='fill:%23cba135; stroke:%23cba135;'%3E%3Ccircle cx='250' cy='250' r='240' style='fill:none; stroke-width:4; opacity: 0.7;'/%3E%3Ccircle cx='250' cy='250' r='180' style='fill:none; stroke-width:3; opacity: 0.7;'/%3E%3Ctext x='250' y='235' text-anchor='middle' style='font-size:85px; font-weight:900; font-family:serif; stroke:none;'%3ESMAIC%3C/text%3E%3Ctext x='250' y='285' text-anchor='middle' style='font-size:28px; font-weight:bold; letter-spacing:8px; stroke:none; opacity:0.8;'%3E2026%3C/text%3E%3C/g%3E%3C/svg%3E");
            background-repeat: no-repeat; background-position: center; background-size: contain; mix-blend-mode: multiply;
        }
        [data-theme="dark"] .watermark { filter: invert(1); opacity: 0.08; }

        header { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; padding: 30px; text-align: center; position: relative; z-index: 10; }
        .header-actions { position: absolute; top: 20px; display: flex; gap: 10px; }
        html[dir="rtl"] .header-actions { left: 20px; } 
        html[dir="ltr"] .header-actions { right: 20px; }
        .icon-btn { background: rgba(255,255,255,0.2); border: none; width: 35px; height: 35px; border-radius: 50%; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; font-weight: bold; transition: 0.2s; }

        /* === Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¹ØµØ±ÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯ === */
        .dashboard { padding: 40px 20px; display: flex; flex-direction: column; align-items: center; position: relative; z-index: 1; }
        .gauge-container { position: relative; width: 260px; height: 135px; margin: 0 auto; display: flex; justify-content: center; align-items: flex-end; }
        .gauge-svg { width: 100%; height: 100%; overflow: visible; }
        .gauge-bg-arc { fill: none; stroke: rgba(0,0,0,0.08); stroke-width: 14; stroke-linecap: round; }
        [data-theme="dark"] .gauge-bg-arc { stroke: rgba(255,255,255,0.08); }
        .gauge-value-arc { fill: none; stroke: url(#gaugeGradient); stroke-width: 14; stroke-linecap: round; stroke-dasharray: 251.2; stroke-dashoffset: 251.2; transition: stroke-dashoffset 1.5s cubic-bezier(0.4, 0, 0.2, 1); filter: url(#glow); }
        .score-display { position: absolute; bottom: 0; font-size: 3.8rem; font-weight: 900; background: linear-gradient(135deg, var(--primary), var(--primary-dark)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; transition: 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        [data-theme="dark"] .score-display { background: linear-gradient(135deg, #fff, #cbd5e1); -webkit-background-clip: text; }

        #motivationQuote { margin: 25px auto; padding: 20px; border-radius: 16px; background: linear-gradient(145deg, #1e293b, #0f172a); color: #f1f5f9; border-right: 6px solid var(--accent); box-shadow: 0 10px 30px rgba(0,0,0,0.15); max-width: 85%; display: none; animation: slideUp 0.6s ease; text-align: right; }
        html[dir="ltr"] #motivationQuote { border-right: none; border-left: 6px solid var(--accent); text-align: left; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .controls { padding: 20px; display: flex; gap: 12px; flex-wrap: wrap; background: var(--mention-bg); justify-content: center; position: relative; z-index: 10; }
        button { min-width: 120px; padding: 12px 20px; border-radius: 12px; border: none; cursor: pointer; font-family: inherit; font-weight: 700; transition: 0.2s; font-size: 0.9rem; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-add { background: var(--primary); color: white; flex: 2; }
        .btn-exp { background: #1e293b; color: white; flex: 1; }
        .btn-pdf { background: #ef4444; color: white; flex: 1; }
        .btn-rst { background: white; color: var(--danger); border: 1px solid var(--danger); flex: 0; }
        [data-theme="dark"] .btn-rst { background: transparent; }

        .table-container { padding: 20px; overflow-x: auto; position: relative; z-index: 10; }
        table { width: 100%; border-collapse: separate; border-spacing: 0 10px; }
        th { color: #64748b; font-size: 0.85rem; padding-bottom: 10px; text-align: center; }
        td { background: var(--input-bg); padding: 5px; border-top: 1px solid rgba(0,0,0,0.05); border-bottom: 1px solid rgba(0,0,0,0.05); }
        html[dir="rtl"] td:first-child { border-radius: 0 10px 10px 0; border-right: 4px solid var(--primary); }
        html[dir="ltr"] td:first-child { border-radius: 10px 0 0 10px; border-left: 4px solid var(--primary); }
        
        input, select { width: 100%; padding: 10px; border: none; background: transparent; font-family: inherit; color: inherit; text-align: center; font-weight: 600; outline: none; }

        /* Transcript Template (A4) */
        #transcript-template { display: none; background: white; color: black; font-family: 'Amiri', serif; width: 210mm; padding: 15mm; direction: rtl; }
        .tr-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .tr-table th, .tr-table td { border: 1px solid #000; padding: 8px; text-align: center; }
    </style>
</head>
<body>

<audio id="sound-success" src="https://assets.mixkit.co/active_storage/sfx/2000/2000-preview.mp3"></audio>
<audio id="sound-fail" src="https://assets.mixkit.co/active_storage/sfx/2018/2018-preview.mp3"></audio>

<div class="container" id="captureArea">
    <div class="watermark"></div>
    <header>
        <div class="header-actions">
            <button onclick="toggleTheme()" class="icon-btn">ğŸŒ™</button>
            <button onclick="toggleLang()" class="icon-btn">EN</button>
        </div>
        <h1 id="txt-title" style="margin:0; font-size:1.8rem; font-weight: 900;">Ù†Ø§Ø¯ÙŠ Ø¹Ù„ÙˆÙ… Ø§Ù„Ù…Ø§Ø¯Ø© Ù„Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</h1>
        <h2 id="txt-subtitle" style="margin:5px 0 0; font-weight:400; opacity:0.9; font-size:1rem; letter-spacing: 1px;">SMAIC - GPA CALCULATOR 2026</h2>
    </header>

    <div id="welcome-msg" style="text-align: center; color: var(--primary); font-weight: 700; margin: 15px 20px; min-height: 1.5em; font-size: 0.95rem;"></div>

    <div class="dashboard">
        <div class="gauge-container">
            <svg class="gauge-svg" viewBox="0 0 200 110">
                <defs>
                    <linearGradient id="gaugeGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                        <stop offset="0%" style="stop-color:var(--danger); stop-opacity:1" />
                        <stop offset="50%" style="stop-color:var(--accent); stop-opacity:1" />
                        <stop offset="100%" style="stop-color:var(--success); stop-opacity:1" />
                    </linearGradient>
                    <filter id="glow">
                        <feGaussianBlur stdDeviation="2.5" result="coloredBlur"/>
                        <feMerge><feMergeNode in="coloredBlur"/><feMergeNode in="SourceGraphic"/></feMerge>
                    </filter>
                </defs>
                <path class="gauge-bg-arc" d="M 20 100 A 80 80 0 0 1 180 100" />
                <path id="gaugePath" class="gauge-value-arc" d="M 20 100 A 80 80 0 0 1 180 100" />
            </svg>
            <div class="score-display" id="finalScore">0.00</div>
        </div>
        <div id="motivationQuote"></div>
    </div>

    <div class="controls" data-html2canvas-ignore="true">
        <button class="btn-add" onclick="addRow()"><span id="txt-add">+ Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø©</span></button>
        <button class="btn-exp" onclick="exportToImage()">ğŸ“· <span id="txt-exp">ØµÙˆØ±Ø©</span></button>
        <button class="btn-pdf" onclick="exportToPDF()">ğŸ“„ <span id="txt-pdf">ÙƒØ´Ù Ù†Ù‚Ø§Ø·</span></button>
        <button class="btn-rst" onclick="resetData()"><span id="txt-rst">ØªØµÙÙŠØ±</span></button>
    </div>

    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th width="35%" id="th-name">Ø§Ù„Ù…Ø§Ø¯Ø©</th>
                    <th width="15%" id="th-exam">Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†</th>
                    <th width="15%" id="th-td">TD/TP</th>
                    <th width="10%" id="th-coef">Ø§Ù„Ù…Ø¹Ø§Ù…Ù„</th>
                    <th width="25%" id="th-mode">Ø§Ù„Ù†Ø¸Ø§Ù…</th>
                    <th width="5%"></th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>

    <div class="footer-area" style="text-align: center; padding: 15px; background: var(--card-bg); z-index:10; position:relative;">
        <button onclick="toggleAbout()" id="btn-about" style="background:none; color:var(--text-main); text-decoration:underline; opacity:0.7; font-size: 0.8rem; width: auto; margin: 0 auto;">ğŸ“± Ø±Ø¤ÙŠØ© SMAIC Ø§Ù„Ø±Ù‚Ù…ÙŠØ©</button>
    </div>

    <div id="aboutModal" style="display:none; padding:25px; background:var(--mention-bg); text-align:center;">
        <h3 id="about-title">ğŸ“± Ø±ÙÙŠÙ‚Ùƒ Ø§Ù„Ø±Ù‚Ù…ÙŠ Ù†Ø­Ùˆ Ø§Ù„ØªÙ…ÙŠØ²</h3>
        <p id="about-text">ØªÙ… ØªØ·ÙˆÙŠØ± Ù‡Ø°Ø§ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙƒØ¥Ø­Ø¯Ù‰ Ù…Ø¨Ø§Ø¯Ø±Ø§Øª Ù†Ø§Ø¯ÙŠ SMAIC.</p>
        <small style="display:block; margin-top:15px; font-weight:bold;">Developed by: Kourde Boudjamaa</small>
    </div>
</div>

<div id="transcript-template">
    <div style="text-align:center; border-bottom:2px solid #000; padding-bottom:10px;">
        <h3>Ø¬Ø§Ù…Ø¹Ø© Ù‚Ø§ØµØ¯ÙŠ Ù…Ø±Ø¨Ø§Ø­ ÙˆØ±Ù‚Ù„Ø© - UKMO</h3>
        <h1>ÙƒØ´Ù Ù†Ù‚Ø§Ø· Ù…Ø¤Ù‚Øª (Ù…Ø­Ø§ÙƒØ§Ø©)</h1>
        <p>Ø§Ù„Ø³Ù†Ø© Ø§Ù„Ø¬Ø§Ù…Ø¹ÙŠØ©: 2025/2026</p>
    </div>
    <div style="display:flex; justify-content:space-between; margin:20px 0; border:1px solid #000; padding:10px;">
        <div><span id="tr-student-label">Ø§Ù„Ø·Ø§Ù„Ø¨(Ø©):</span> <b id="tr-student-name"></b></div>
        <div><span>Ø§Ù„ØªØ§Ø±ÙŠØ®:</span> <b id="tr-date"></b></div>
    </div>
    <table class="tr-table">
        <thead>
            <tr><th>Ø§Ù„Ù…Ø§Ø¯Ø©</th><th>Ø§Ù„Ù…Ø¹Ø§Ù…Ù„</th><th>Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†</th><th>TD/TP</th><th>Ø§Ù„Ù…Ø¹Ø¯Ù„</th></tr>
        </thead>
        <tbody id="tr-body"></tbody>
    </table>
    <div style="margin-top:30px; display:flex; justify-content:flex-end;">
        <div style="border:2px solid #000; padding:15px; text-align:center; min-width:150px;">
            <h3>Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø§Ù„ÙØµÙ„ÙŠ</h3>
            <div id="tr-gpa" style="font-size:2rem; font-weight:bold;">0.00</div>
            <div id="tr-decision" style="margin-top:5px; font-weight:bold;"></div>
        </div>
    </div>
</div>

<script>
    const langData = {
        ar: {
            title: "Ù†Ø§Ø¯ÙŠ Ø¹Ù„ÙˆÙ… Ø§Ù„Ù…Ø§Ø¯Ø© Ù„Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ", subtitle: "SMAIC - Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø§Ù„Ù…Ù„ÙƒÙŠØ© 2026", welcome: "Ø¨ÙˆØ§Ø¨Ø© SMAIC Ø§Ù„Ø±Ù‚Ù…ÙŠØ©: Ø­ÙŠØ« Ù„Ø§ ØªÙÙ‚Ø§Ø³ Ù‚ÙŠÙ…ØªÙƒ Ø¨Ù…Ø§ ØªØ­Ù…Ù„Ù‡ Ø§Ù„ÙˆØ±Ù‚Ø©ØŒ Ø¨Ù„ Ø¨Ù…Ø§ ÙŠØ³ØªØ·ÙŠØ¹Ù‡ Ø¹Ù‚Ù„Ùƒ..", add: "+ Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø©", exp: "ØµÙˆØ±Ø©", pdf: "ÙƒØ´Ù Ù†Ù‚Ø§Ø·", rst: "ØªØµÙÙŠØ±", th_name: "Ø§Ù„Ù…Ø§Ø¯Ø©", th_exam: "Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†", th_td: "TD/TP", th_coef: "Ø§Ù„Ù…Ø¹Ø§Ù…Ù„", th_mode: "Ø§Ù„Ù†Ø¸Ø§Ù…", about_btn: "ğŸ“± Ø±Ø¤ÙŠØ© SMAIC Ø§Ù„Ø±Ù‚Ù…ÙŠØ©", about_title: "ğŸ“± Ø±ÙÙŠÙ‚Ùƒ Ø§Ù„Ø±Ù‚Ù…ÙŠ Ù†Ø­Ùˆ Ø§Ù„ØªÙ…ÙŠØ²", about_text: "ØªÙ… ØªØ·ÙˆÙŠØ± Ù‡Ø°Ø§ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙƒØ¥Ø­Ø¯Ù‰ Ù…Ø¨Ø§Ø¯Ø±Ø§Øª <b>Ù†Ø§Ø¯ÙŠ SMAIC</b>.", ph_name: "Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©...", mode_mixed: "67% + 33%", mode_70: "70% + 30%", mode_60: "60% + 40%", mode_50: "50% + 50%", mode_100: "100% Ø¥Ù…ØªØ­Ø§Ù†", mode_100td: "100% TD", sig: "SMAIC ÙˆØ·Ù† Ø§Ù„Ø®Ø§Ù„Ø¯ÙŠÙ†.. Ù…ÙƒØ§Ù†Ùƒ Ø¨ÙŠÙ† Ø§Ù„Ø¹Ø¸Ù…Ø§Ø¡.", tr_title: "ÙƒØ´Ù Ù†Ù‚Ø§Ø· Ù…Ø­Ø§ÙƒØ§Ø©"
        },
        en: {
            title: "Physics & AI Club", subtitle: "SMAIC - ROYAL CALCULATOR 2026", welcome: "SMAIC Digital: Your value is measured by your mind, not by paper.", add: "+ Add Subject", exp: "Image", pdf: "PDF", rst: "Reset", th_name: "Subject", th_exam: "Exam", th_td: "TD/TP", th_coef: "Coef", th_mode: "Mode", about_btn: "ğŸ“± SMAIC Vision", about_title: "ğŸ“± Digital Excellence", about_text: "Developed by <b>SMAIC Club</b>.", ph_name: "Subject...", mode_mixed: "67/33%", mode_70: "70/30%", mode_60: "60/40%", mode_50: "50/50%", mode_100: "100% Exam", mode_100td: "100% TD", sig: "SMAIC: Where legends are made.", tr_title: "Simulation Transcript"
        }
    };

    const quotesDB = {
        ar: {
            diamond: { title: "Ù…Ù‚Ø§Ù… Ø§Ù„ØªÙØ±Ù‘Ø¯ ğŸ’", text: ["Ø£Ù†Øª Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ© Ø§Ù„Ø¥Ø¨Ø¯Ø§Ø¹ Ø§Ù„ØªÙŠ Ø¨Ù„ØºØª Ø§Ù„ÙƒÙ…Ø§Ù„."] },
            gold: { title: "Ù…Ù‚Ø§Ù… Ø§Ù„Ø³ÙŠØ§Ø¯Ø© ğŸ¥‡", text: ["Ø¨Ø°ÙƒØ§Ø¡Ù Ø³ÙŠØ§Ø¯ÙŠÙ‘ ÙØ±Ø¶ØªÙ Ù…Ù†Ø·Ù‚Ùƒ."] },
            silver: { title: "Ù…Ù‚Ø§Ù… Ø§Ù„Ø§ØªØ²Ø§Ù† ğŸ¥ˆ", text: ["Ø®Ø·ÙˆØ§ØªÙƒ Ø«Ø§Ø¨ØªØ©.. SMAIC Ù…ÙƒØ§Ù†Ùƒ Ø§Ù„Ø£Ù†Ø³Ø¨."] },
            resilience: { title: "Ù…Ù‚Ø§Ù… Ø§Ù„Ø«Ø¨Ø§Øª ğŸ¥‰", text: ["Ø¹Ø¨Ø±ØªÙ Ø¨Ø³Ù„Ø§Ù…ØŒ ÙˆØ§Ù„Ø¹Ø¨Ø±Ø© Ø¨Ø§Ù„Ù†ÙØ³ Ø§Ù„Ø·ÙˆÙŠÙ„."] },
            challenge: { title: "Ù…Ù‚Ø§Ù… Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© ğŸ”„", text: ["Ø³Ù‚ÙˆØ·Ùƒ Ø§Ù„ÙŠÙˆÙ… Ù‡Ùˆ Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ù„Ù†Ø¸Ø§Ù…Ùƒ."] }
        },
        en: {
            diamond: { title: "Singularity ğŸ’", text: ["You are an algorithm of perfection."] },
            gold: { title: "Sovereignty ğŸ¥‡", text: ["You imposed your logic with brilliance."] },
            silver: { title: "Equilibrium ğŸ¥ˆ", text: ["Steady steps towards greatness."] },
            resilience: { title: "Ground State ğŸ¥‰", text: ["You passed, endurance is key."] },
            challenge: { title: "System Reset ğŸ”„", text: ["Failure is just a system reboot."] }
        }
    };

    let curLang = 'ar', lastState = null, welcomeIndex = 0, subjects = [{name: "", exam: null, td: null, coef: 1, mode: "mixed"}];

    window.onload = () => { if(localStorage.getItem('smaic_v2')) subjects = JSON.parse(localStorage.getItem('smaic_v2')); renderTable(); startType(); };

    function startType() { document.getElementById("welcome-msg").innerHTML = ""; welcomeIndex = 0; type(); }
    function type() { const txt = langData[curLang].welcome; if(welcomeIndex < txt.length) { document.getElementById("welcome-msg").innerHTML += txt.charAt(welcomeIndex); welcomeIndex++; setTimeout(type, 30); } }

    function toggleLang() { curLang = curLang === 'ar' ? 'en' : 'ar'; document.documentElement.dir = curLang==='ar'?'rtl':'ltr'; updateUI(); startType(); renderTable(); }
    function updateUI() {
        const t = langData[curLang];
        document.getElementById('txt-title').innerText = t.title;
        document.getElementById('txt-subtitle').innerText = t.subtitle;
        ['add','exp','pdf','rst','th-name','th-exam','th-td','th-coef','th-mode'].forEach(id => document.getElementById(`txt-${id}`||id).innerText = t[id.replace('-','_')]);
    }

    function renderTable() {
        document.getElementById('tableBody').innerHTML = subjects.map((s, i) => `
            <tr>
                <td><input type="text" placeholder="${langData[curLang].ph_name}" value="${s.name}" oninput="update(${i},'name',this.value)"></td>
                <td><input type="number" step="0.01" value="${s.exam||''}" oninput="update(${i},'exam',this.value)" ${s.mode==='100td'?'disabled':''}></td>
                <td><input type="number" step="0.01" value="${s.td||''}" oninput="update(${i},'td',this.value)" ${s.mode==='100exam'?'disabled':''}></td>
                <td><input type="number" value="${s.coef}" oninput="update(${i},'coef',this.value)"></td>
                <td><select onchange="update(${i},'mode',this.value)">
                    <option value="mixed" ${s.mode==='mixed'?'selected':''}>${langData[curLang].mode_mixed}</option>
                    <option value="7030" ${s.mode==='7030'?'selected':''}>${langData[curLang].mode_70}</option>
                    <option value="100exam" ${s.mode==='100exam'?'selected':''}>${langData[curLang].mode_100}</option>
                </select></td>
                <td><button onclick="remove(${i})" style="color:var(--danger); background:none; min-width:auto;">âœ•</button></td>
            </tr>
        `).join('');
        calculate();
    }

    function update(i,f,v) { subjects[i][f] = (f==='name'||f==='mode')?v:parseFloat(v); if(f==='mode') renderTable(); calculate(); localStorage.setItem('smaic_v2', JSON.stringify(subjects)); }
    function addRow() { subjects.push({name:"", exam:null, td:null, coef:1, mode:"mixed"}); renderTable(); }
    function remove(i) { subjects.splice(i,1); renderTable(); }

    function calculate() {
        let tw = 0, tc = 0, hasData = false;
        subjects.forEach(s => {
            let m = 0, ex = s.exam||0, td = s.td||0;
            if(s.mode==='mixed') m = ex*0.67+td*0.33; else if(s.mode==='7030') m = ex*0.7+td*0.3; else m = ex;
            tw += m * (s.coef||1); tc += (s.coef||1);
            if(s.exam!==null || s.td!==null) hasData = true;
        });
        const gpa = tc > 0 ? tw/tc : 0;
        document.getElementById('finalScore').innerText = gpa.toFixed(2);
        
        // Gauge Update
        const circ = 251.2;
        document.getElementById('gaugePath').style.strokeDashoffset = circ - ((gpa/20)*circ);
        
        // Effects
        if(hasData && gpa > 0) {
            let state = gpa >= 10 ? 'pass' : 'fail';
            if(state !== lastState) {
                document.getElementById(`sound-${state}`).play().catch(()=>{});
                if(state==='pass') confetti({particleCount:100, spread:70, origin:{y:0.6}});
                lastState = state;
            }
            updateQuote(gpa);
        }
    }

    function updateQuote(gpa) {
        const q = quotesDB[curLang];
        let cat = gpa>=17?q.diamond:gpa>=14?q.gold:gpa>=12?q.silver:gpa>=10?q.resilience:q.challenge;
        const box = document.getElementById('motivationQuote');
        box.innerHTML = `<small style="color:var(--accent)">${cat.title}</small><div>"${cat.text[0]}"</div>`;
        box.style.display = 'block';
    }

    function exportToImage() {
        const area = document.getElementById('captureArea');
        htmlToImage.toPng(area).then(data => { const link = document.createElement('a'); link.download='SMAIC.png'; link.href=data; link.click(); });
    }

    function exportToPDF() {
        const name = prompt("Name:"); if(!name) return;
        document.getElementById('tr-student-name').innerText = name;
        document.getElementById('tr-date').innerText = new Date().toLocaleDateString();
        document.getElementById('tr-gpa').innerText = document.getElementById('finalScore').innerText;
        const temp = document.getElementById('transcript-template');
        temp.style.display = 'block';
        html2pdf().from(temp).save().then(()=>temp.style.display='none');
    }

    function toggleTheme() { const h = document.documentElement; h.setAttribute('data-theme', h.getAttribute('data-theme')==='light'?'dark':'light'); }
    function toggleAbout() { const m = document.getElementById('aboutModal'); m.style.display = m.style.display==='none'?'block':'none'; }
    function resetData() { if(confirm("Reset?")) { subjects=[{name:"", exam:null, td:null, coef:1, mode:"mixed"}]; renderTable(); } }
</script>
</body>
</html>
